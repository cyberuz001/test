<!-- SAVE AS index.html and replace API_BASE with your backend URL -->
<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Market — Mini App</title>

  <!-- Tailwind for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* ---------- CORE STYLES ---------- */
    :root{
      --bg:#071226; --card:#0b1220; --muted:#9aa6b2; --accent:#3b82f6; --accent2:#10b981;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071226 0%, #081228 100%);color:#e6eef8;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .app {min-height:100vh; display:flex; flex-direction:column; padding-bottom:86px;}
    .container {max-width:1080px;margin:0 auto;padding:16px;}
    header.site-header{display:flex;align-items:center;justify-content:space-between;padding:8px 0;}
    .logo{font-weight:700;font-size:18px;color:var(--accent);}

    /* ---------- CAROUSEL (admin only) ---------- */
    .carousel {display:flex; gap:12px; overflow-x:auto; padding:8px 0; margin-bottom:12px; -webkit-overflow-scrolling:touch;}
    .carousel img{height:140px;border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.5); object-fit:cover; flex-shrink:0; min-width:260px;}

    /* ---------- CARD GRID ---------- */
    .cards {display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px;}
    .card {background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px; border-radius:12px; box-shadow:0 6px 18px rgba(2,6,23,0.6); position:relative; overflow:hidden;}
    .card img {width:100%; height:140px; object-fit:cover; border-radius:8px;}
    .card .title {font-weight:600; margin-top:8px; color:#e6eef8;}
    .card .meta {font-size:13px;color:var(--muted); margin-top:6px;}
    .card .actions {display:flex; gap:8px; margin-top:10px; align-items:center;}
    .btn {padding:8px 10px; border-radius:10px; cursor:pointer; border:none; font-weight:600;}
    .btn-primary {background:linear-gradient(90deg,var(--accent),#60a5fa); color:white;}
    .btn-ghost {background:transparent;color:var(--muted); border:1px solid rgba(255,255,255,0.04);}

    /* three dots menu */
    .menu-dot {position:absolute; top:10px; right:10px; font-size:18px; cursor:pointer; padding:6px; border-radius:8px; background:rgba(255,255,255,0.02);}
    .menu-box {position:absolute; right:12px; top:38px; background:#051022; border-radius:8px; padding:6px; display:none; z-index:40; border:1px solid rgba(255,255,255,0.03);}
    .menu-box button{display:block; width:200px; text-align:left; padding:8px; border:none; background:transparent; color:var(--muted); cursor:pointer;}

    /* ---------- PAGES ---------- */
    .page {display:none;}
    .page.active {display:block;}

    /* ---------- BOTTOM NAV ---------- */
    .bottom-nav {position:fixed; left:0; right:0; bottom:0; height:72px; background:linear-gradient(180deg, rgba(2,6,23,0.94), rgba(2,6,23,0.98)); display:flex; gap:8px; justify-content:center; align-items:center; border-top:1px solid rgba(255,255,255,0.03); z-index:60;}
    .nav-item{flex:1; text-align:center; color:var(--muted); font-weight:700; cursor:pointer;}
    .nav-item.active{color:var(--accent);}

    /* ---------- CHAT ---------- */
    .chat-wrap {display:flex; flex-direction:column; height:calc(100vh - 80px);}
    .messages{flex:1; overflow:auto; padding:12px;}
    .chat-input-wrap{display:flex; gap:8px; padding:10px; border-top:1px solid rgba(255,255,255,0.03); background:linear-gradient(180deg,#071226,#081226);}
    .chat-input{flex:1; padding:10px 12px; border-radius:999px; background:#061022; border:1px solid rgba(255,255,255,0.03); color:#dfeefe;}

    /* ---------- PROFILE BLOCK ---------- */
    .blocked-box{padding:30px;text-align:center;background:linear-gradient(180deg,#081226,#061022); border-radius:12px;}
    .profile-photo{width:96px;height:96px;border-radius:12px;object-fit:cover}

    /* ---------- MODAL ---------- */
    .modal-overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:80}
    .modal{background:#041022;padding:16px;border-radius:12px;width:100%;max-width:720px;border:1px solid rgba(255,255,255,0.03)}

    /* responsive */
    @media (max-width:768px){
      .cards{grid-template-columns:1fr}
      .carousel img{min-width:200px;height:120px}
      .menu-box button{width:160px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="container">
      <header class="site-header">
        <div class="logo">Game Market</div>
        <div class="flex items-center gap-2">
          <button id="btnOpenCreate" class="btn btn-ghost">E'lon yaratish</button>
          <button id="btnAdminMode" class="btn btn-ghost">Admin mode</button>
        </div>
      </header>

      <!-- HOME PAGE -->
      <main id="home-page" class="page active">
        <!-- carousel - only admin -->
        <div id="carousel" class="carousel" aria-hidden="false"></div>

        <section>
          <h3 class="text-lg font-semibold mb-2">Barcha mahsulotlar</h3>
          <div id="cards" class="cards"></div>
        </section>
      </main>

      <!-- MY LISTINGS -->
      <section id="my-listings-page" class="page p-4">
        <h3 class="text-lg font-semibold mb-3">Mening e'lonlarim</h3>
        <div id="my-listings" class="cards"></div>
      </section>

      <!-- PROFILE -->
      <section id="profile-page" class="page p-4">
        <div id="profile-area"></div>
      </section>

      <!-- CHAT -->
      <section id="chat-page" class="page p-0">
        <div class="chat-wrap">
          <div class="messages" id="chat-messages">
            <div style="color:var(--muted);padding:12px">Qo'llab-quvvatlashga xush kelibsiz — Savolingizni yozing.</div>
          </div>
          <div class="chat-input-wrap">
            <input id="chat-input" class="chat-input" placeholder="Xabar yozing..." />
            <button id="send-chat" class="btn btn-primary">Yuborish</button>
          </div>
        </div>
      </section>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav" id="bottom-nav">
      <div class="nav-item active" data-target="home-page">Bosh sahifa</div>
      <div class="nav-item" data-target="my-listings-page">Mening e'lonlarim</div>
      <div class="nav-item" data-target="profile-page">Profil</div>
      <div class="nav-item" data-target="chat-page">Yordam</div>
    </nav>
  </div>

  <!-- MODAL: Create / Edit Listing -->
  <div id="modalRoot" style="display:none" class="modal-overlay">
    <div class="modal">
      <h4 class="font-bold mb-2">E'lon yaratish / tahrirlash</h4>
      <form id="listingForm" class="space-y-3">
        <input id="lst-id" type="hidden" />
        <div>
          <label class="text-sm text-gray-300">Platforma</label>
          <select id="lst-platform" class="w-full p-2 rounded-md bg-[#06122a]">
            <option value="twitter">Twitter</option>
            <option value="google">Google</option>
            <option value="facebook">Facebook</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-300">Title</label>
          <input id="lst-title" type="text" class="w-full p-2 rounded-md bg-[#06122a]" required />
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-gray-300">Login</label>
            <input id="lst-login" type="text" class="w-full p-2 rounded-md bg-[#06122a]" required />
          </div>
          <div>
            <label class="text-sm text-gray-300">Parol</label>
            <input id="lst-pass" type="text" class="w-full p-2 rounded-md bg-[#06122a]" required />
          </div>
        </div>
        <div>
          <label class="text-sm text-gray-300">Narx (Stars)</label>
          <input id="lst-price" type="number" class="w-full p-2 rounded-md bg-[#06122a]" required />
        </div>
        <div>
          <label class="text-sm text-gray-300">Rasmlar (link)</label>
          <input id="lst-images" type="text" class="w-full p-2 rounded-md bg-[#06122a]" placeholder="Agar bir nechta bo'lsa, vergul bilan ajrating" />
        </div>

        <div class="flex gap-2 justify-end mt-2">
          <button type="button" id="saveListingBtn" class="btn btn-primary">Saqlash</button>
          <button type="button" id="cancelListingBtn" class="btn btn-ghost">Bekor qilish</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* =======================
   CONFIG
   ======================= */
// Backend base URL — o'zingizning backendga o'zgartiring
const API_BASE = 'https://your-backend.example/api';

// Telegram WebApp
const tg = window.Telegram ? window.Telegram.WebApp : null;
if (tg && tg.expand) {
  try { tg.expand(); } catch(e){}
}

/* =======================
   STATE
   ======================= */
// currentUser: o'zgartiring yoki backenddan yuklang (auth)
let currentUser = {
  telegram_id: 12345,
  username: "user1",
  is_admin: true, // agar admin bo'lsa true
  is_blocked: false
};

// listings — odatda backenddan olinadi; bu demo uchun boshlang'ich
let listings = [
  { id: 101, title: "Admin: Premium Twitter account", platform:"twitter", login:"@proacc", pass:"pw123", price_stars: 120, images:[], owner:'admin', ad:true, sold:false },
  { id: 201, title: "Google account level 5", platform:"google", login:"user123", pass:"pw123", price_stars: 30, images:[], owner:'userA', ad:false, sold:false },
  { id: 202, title: "Facebook old account", platform:"facebook", login:"fb_user", pass:"pwFB", price_stars: 45, images:[], owner:'userB', ad:false, sold:false },
];

let isAdminView = currentUser.is_admin;
let isBlocked = currentUser.is_blocked;

/* =======================
   UTIL
   ======================= */
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, (m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function q(sel){ return document.querySelector(sel); }
function qAll(sel){ return document.querySelectorAll(sel); }

/* =======================
   RENDER
   ======================= */
function renderCarousel(){
  const el = q('#carousel'); el.innerHTML = '';
  if (!isAdminView) { el.style.display = 'none'; return; }
  el.style.display = 'flex';
  // images typically from backend admin carousel
  const imgs = [
    'https://images.unsplash.com/photo-1622495896217-1e6b1c0eeb1b?w=1200&q=60',
    'https://images.unsplash.com/photo-1602524815666-4d4a6df5d2c4?w=1200&q=60'
  ];
  imgs.forEach(src=>{
    const img = document.createElement('img'); img.src = src; img.alt='ad'; el.appendChild(img);
  });
}

function renderCards(){
  const container = q('#cards'); container.innerHTML = '';

  // Filter out fake/invalid cards (backend should ensure)
  const validListings = listings.filter(l=>l && !l.is_fake);

  // admin listings first, others random (except sold)
  const adminList = validListings.filter(l=>l.ad).sort((a,b)=>a.id-b.id);
  const others = validListings.filter(l=>!l.ad && !l.sold);

  // randomize others
  for (let i = others.length -1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [others[i], others[j]] = [others[j], others[i]];
  }

  const all = [...adminList, ...others];

  all.forEach(l=>{
    const card = document.createElement('div'); card.className = 'card';
    const imgSrc = (l.images && l.images.length) ? l.images[0] : 'https://via.placeholder.com/640x360?text=Account';
    card.innerHTML = `
      <div class="menu-dot" data-id="${l.id}">⋮</div>
      <div class="menu-box" id="menu-${l.id}" style="display:none">
        <button onclick="copyLink(${l.id}); event.stopPropagation();">Havolani nusxalash</button>
        <button onclick="shareListing(${l.id}); event.stopPropagation();">Ulashish</button>
      </div>
      <img src="${escapeHtml(imgSrc)}" alt="">
      <div class="title">${escapeHtml(l.title)} ${l.sold ? ' — <span style="color:#f59e0b">Sotildi</span>':''}</div>
      <div class="meta">Platforma: ${escapeHtml(l.platform)} • Narx: ${l.price_stars} ⭐</div>
      <div class="actions">
        ${ l.ad ? `<button class="btn btn-primary" onclick="buy(${l.id})">${l.price_stars} ⭐ Sotib olish</button>` : '' }
        <button class="btn btn-ghost" onclick="openDetail(${l.id})">Ko'rish</button>
      </div>
    `;
    container.appendChild(card);

    // menu toggle
    const dot = card.querySelector('.menu-dot');
    const box = card.querySelector('.menu-box');
    dot.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      document.querySelectorAll('.menu-box').forEach(b=>b.style.display='none');
      box.style.display = box.style.display === 'block' ? 'none' : 'block';
    });
  });

  // close menus on outside click
  document.body.addEventListener('click', ()=> document.querySelectorAll('.menu-box').forEach(b=>b.style.display='none'));
}

function renderMyListings(){
  const container = q('#my-listings'); container.innerHTML = '';
  const mine = listings.filter(l=>l.owner === 'admin' || l.owner === currentUser.username);
  if (mine.length === 0) { container.innerHTML = `<div class="text-muted">Hozircha e'lonlaringiz yo'q</div>`; return; }
  mine.forEach(l=>{
    const el = document.createElement('div'); el.className='card';
    const imgSrc = (l.images && l.images.length) ? l.images[0] : 'https://via.placeholder.com/640x360?text=Account';
    el.innerHTML = `
      <img src="${escapeHtml(imgSrc)}" alt="">
      <div class="title">${escapeHtml(l.title)}</div>
      <div class="meta">Platforma: ${escapeHtml(l.platform)} • Narx: ${l.price_stars} ⭐</div>
      <div class="actions">
        <button class="btn btn-ghost" onclick="openEdit(${l.id})">Edit</button>
        <button class="btn btn-ghost" onclick="confirmDelete(${l.id})">Delete</button>
        <button class="btn btn-primary" onclick="markSold(${l.id})">${l.sold ? 'Sotildi' : 'Mark Sotildi'}</button>
      </div>
    `;
    container.appendChild(el);
  });
}

function renderProfile(){
  const area = q('#profile-area');
  if (isBlocked){
    area.innerHTML = `
      <div class="blocked-box">
        <img class="profile-photo" src="https://via.placeholder.com/96" />
        <div style="font-weight:700;margin-top:8px">Foydalanuvchi (${escapeHtml(currentUser.username)})</div>
        <div style="color:var(--muted); margin-top:8px">Siz bloklangansiz</div>
        <div style="margin-top:12px"><button class="btn btn-ghost" onclick="contactSupport()">Supportga yozish</button></div>
      </div>
    `;
    q('#bottom-nav').style.display = 'none';
  } else {
    q('#bottom-nav').style.display = 'flex';
    area.innerHTML = `
      <div class="card" style="display:flex;gap:12px;align-items:center">
        <img src="https://via.placeholder.com/96" style="width:96px;height:96px;border-radius:12px;object-fit:cover" />
        <div>
          <div style="font-weight:700">Foydalanuvchi (${escapeHtml(currentUser.username)})</div>
          <div style="color:var(--muted)">Balance: <span id="user-balance">0</span> ⭐</div>
          <div style="margin-top:8px"><button class="btn btn-primary" onclick="openCreate()">${currentUser.is_admin ? 'Admin: yangi e\'lon' : 'E\'lon yaratish'}</button></div>
        </div>
      </div>
      <div class="mt-4">
        <h4 class="font-semibold mb-2">Mening sotib olinganlar</h4>
        <div id="my-purchases" class="cards"></div>
      </div>
    `;
    renderPurchases();
  }
}

function renderPurchases(){
  const container = q('#my-purchases');
  container.innerHTML = '';
  const purchases = listings.filter(l=> l.buyer === currentUser.username);
  if (!purchases.length) { container.innerHTML = '<div class="text-muted">Hozircha sotib olinganlar yo‘q</div>'; return; }
  purchases.forEach(l=>{
    const el = document.createElement('div'); el.className='card';
    const img = (l.images && l.images[0]) || 'https://via.placeholder.com/640x360?text=Account';
    el.innerHTML = `<img src="${escapeHtml(img)}"><div class="title">${escapeHtml(l.title)}</div><div class="meta">Login: ${escapeHtml(l.login)} • Parol: ${escapeHtml(l.pass)}</div>`;
    container.appendChild(el);
  });
}

function renderAll(){
  renderCarousel();
  renderCards();
  renderMyListings();
  renderProfile();
}

/* =======================
   PAGE NAV
   ======================= */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  const nav = document.querySelector(`.nav-item[data-target="${id}"]`);
  if (nav) nav.classList.add('active');

  if (id === 'chat-page') {
    setTimeout(()=>{ const m = q('.messages'); if(m) m.scrollTop = m.scrollHeight; }, 80);
  }
}
qAll('.nav-item').forEach(el=> el.addEventListener('click', ()=> showPage(el.dataset.target)));

/* =======================
   CREATE / EDIT / DELETE
   ======================= */
function openCreate(){
  if (!currentUser) return alert('Login qiling');
  openModal();
  fillForm(null);
}
function openEdit(id){
  const lst = listings.find(x=>x.id===id);
  if (!lst) return alert('E\'lon topilmadi');
  openModal();
  fillForm(lst);
}
function openModal(){ q('#modalRoot').style.display='flex'; }
function closeModal(){ q('#modalRoot').style.display='none'; }
function fillForm(lst){
  q('#lst-id').value = lst ? lst.id : '';
  q('#lst-platform').value = lst ? lst.platform : 'twitter';
  q('#lst-title').value = lst ? lst.title : '';
  q('#lst-login').value = lst ? lst.login : '';
  q('#lst-pass').value = lst ? lst.pass : '';
  q('#lst-price').value = lst ? lst.price_stars : '';
  q('#lst-images').value = lst && lst.images ? lst.images.join(',') : '';
}

q('#cancelListingBtn').addEventListener('click', ()=> closeModal());

q('#saveListingBtn').addEventListener('click', async ()=>{
  const id = q('#lst-id').value;
  const platform = q('#lst-platform').value;
  const title = q('#lst-title').value.trim();
  const login = q('#lst-login').value.trim();
  const pass = q('#lst-pass').value.trim();
  const price = parseInt(q('#lst-price').value) || 0;
  const images = q('#lst-images').value.split(',').map(s=>s.trim()).filter(Boolean);

  if (!title || !login) return alert('Title va login kiriting');

  try {
    if (id){
      const resp = await fetch(`${API_BASE}/listings/${id}`, {
        method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          title, platform, login, pass, price_stars: price, images
        })
      });
      if (!resp.ok) throw new Error('Edit failed');
      const updated = await resp.json();
      listings = listings.map(l=> l.id==id ? {...l, title, platform, login, pass, price_stars:price, images} : l);
      alert('E\'lon tahrirlandi');
    } else {
      const resp = await fetch(`${API_BASE}/listings`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          title, platform, login, pass, price_stars: price, images, owner: currentUser.username, ad: currentUser.is_admin ? true : false
        })
      });
      if (!resp.ok) throw new Error('Create failed');
      const created = await resp.json();
      listings.unshift({...created});
      alert('E\'lon yaratildi');
    }
    closeModal();
    renderAll();
  } catch (err) {
    console.error(err);
    alert('Server bilan ishlashda xatolik: ' + err.message);
  }
});

function confirmDelete(id){
  if (!confirm('E\'lonni o\'chirmoqchimisiz?')) return;
  deleteListing(id);
}

async function deleteListing(id){
  try {
    const resp = await fetch(`${API_BASE}/listings/${id}`, { method: 'DELETE' });
    if (!resp.ok) throw new Error('Delete failed');
    listings = listings.filter(l=>l.id!==id);
    renderAll();
    alert('E\'lon o\'chirildi');
  } catch (err) {
    console.error(err);
    alert('O\'chirishda xatolik: ' + err.message);
  }
}

async function markSold(id){
  const l = listings.find(x=>x.id===id); if(!l) return alert('Topilmadi');
  if (l.sold) return alert('E\'lon allaqachon sotilgan');
  try {
    const resp = await fetch(`${API_BASE}/listings/${id}/mark-sold`, { method:'POST' });
    if (!resp.ok) throw new Error('Server failed');
    l.sold = true;
    renderAll();
    alert('E\'lon sotildi deb belgilandi');
  } catch (err) {
    console.error(err);
    alert('Xatolik: ' + err.message);
  }
}

/* =======================
   COPY / SHARE
   ======================= */
function copyLink(id){
  const url = location.origin + location.pathname + '?listing=' + id;
  navigator.clipboard.writeText(url).then(()=> alert('Havola nusxalandi'));
}
function shareListing(id){
  const url = location.origin + location.pathname + '?listing=' + id;
  if (navigator.share){
    navigator.share({ title:'E\'lon', text:'Bu e\'lonni ko\'ring', url }).catch(()=>{});
  } else {
    alert('Brauzer share API ni qo\'llab-quvvatlamaydi. Nusxalash: ' + url);
  }
}

/* =======================
   OPEN DETAIL (modal or simple)
   ======================= */
function openDetail(id){
  const l = listings.find(x=>x.id===id); if(!l) return alert('Topilmadi');
  const info = `Title: ${l.title}\nPlatforma: ${l.platform}\nLogin: ${l.login}\nNarx: ${l.price_stars} ⭐\n\nAgar hokimiyat: admin elonlari to‘lash orqali olinadi.`;
  if (confirm(info + '\n\nSotib olishni xohlaysizmi?')) {
    if (l.ad) buy(id);
    else alert('Bu e\'lon to‘g‘ridan-to‘g‘ri sotilmaydi (foydalanuvchi eloni).');
  }
}

/* =======================
   CHAT
   ======================= */
q('#send-chat').addEventListener('click', ()=>{
  const txt = q('#chat-input').value.trim();
  if (!txt) return;
  const div = document.createElement('div');
  div.style.margin='8px 0'; div.style.padding='10px'; div.style.background='#06202f'; div.style.borderRadius='12px'; div.textContent = txt;
  q('#chat-messages').appendChild(div);
  q('#chat-input').value='';
  q('.messages').scrollTop = q('.messages').scrollHeight;
});

/* =======================
   BUY -> create invoice (Telegram Stars)
   ======================= */
async function buy(listingId){
  const l = listings.find(x=>x.id===listingId);
  if (!l) return alert('E\'lon topilmadi');
  if (!l.ad) return alert('Bu e\'lon admin orqali sotilmaydi.');

  try {
    const resp = await fetch(`${API_BASE}/create-invoice`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        listing_id: listingId,
        amount_stars: l.price_stars,
        description: l.title,
        buyer_telegram_id: currentUser.telegram_id
      })
    });
    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error('Invoice yaratilmadi: ' + txt);
    }
    const data = await resp.json();
    const invoiceLink = data.invoice_link;

    if (!invoiceLink) throw new Error('Invoice link bo\'sh');

    if (tg && typeof tg.openInvoice === 'function') {
      try {
        tg.openInvoice(invoiceLink, (status) => {
          console.log('openInvoice callback status:', status);
          if (status === 'paid') {
            onSuccessfulPurchase(listingId);
            alert('To\'lov muvaffaqiyatli amalga oshirildi!');
          } else {
            alert('To\'lov holati: ' + status);
          }
        });
      } catch(e) {
        window.open(invoiceLink, '_blank');
        alert('To\'lov oynasi ochildi — agar Telegram ichida bo\'lmasa, sahifada davom eting.');
      }
    } else if (window.open) {
      window.open(invoiceLink, '_blank');
      alert('To\'lov oynasi ochildi — sahifada davom eting.');
    } else {
      alert('Sizning muhitda to\'lovni ochib bo\'lmadi.');
    }
  } catch (err) {
    console.error(err);
    alert('To\'lov hosil qilishda xatolik: ' + err.message);
  }
}

/* Called when payment is known to be successful locally (backend should confirm via webhook too) */
async function onSuccessfulPurchase(listingId){
  try {
    const resp = await fetch(`${API_BASE}/listings/${listingId}/purchase`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
        buyer_telegram_id: currentUser.telegram_id,
        buyer_username: currentUser.username
      })
    });
    if (!resp.ok) throw new Error('Server purchase failed');
    const result = await resp.json();
    const l = listings.find(x=>x.id===listingId);
    if (l) { l.sold = true; l.buyer = currentUser.username; }
    renderAll();
  } catch (err) {
    console.error(err);
    const l = listings.find(x=>x.id===listingId);
    if (l) { l.sold = true; l.buyer = currentUser.username; }
    renderAll();
    alert('Server bilan sinxronlashda xatolik: ' + err.message);
  }
}

/* =======================
   DEEP LINK handling (?listing=)
   ======================= */
(function handleDeepLink(){
  const params = new URLSearchParams(location.search);
  const id = params.get('listing');
  if (id) {
    const numeric = parseInt(id);
    const l = listings.find(x=>x.id===numeric);
    if (l) {
      if (l.ad) buy(numeric);
      else openDetail(numeric);
    }
  }
})();

/* =======================
   ADMIN toggle button (dev)
   ======================= */
q('#btnAdminMode').addEventListener('click', ()=>{
  isAdminView = !isAdminView;
  currentUser.is_admin = isAdminView;
  alert('Admin mode: ' + (isAdminView ? 'ON' : 'OFF'));
  renderAll();
});

/* create listing quick open */
q('#btnOpenCreate').addEventListener('click', ()=>{
  if (!currentUser) return alert('Kirish qilingan emas');
  openCreate();
});

/* init */
renderAll();

/* =======================
   POLLING / WEBSOCKET for updates (recommended)
   ======================= */
let pollInterval = null;
function startPolling(){
  if (pollInterval) clearInterval(pollInterval);
  pollInterval = setInterval(async ()=>{
    try {
      const resp = await fetch(`${API_BASE}/listings`);
      if (resp.ok){
        const data = await resp.json();
        listings = data.listings || listings;
        renderAll();
      }
    } catch(e){
      console.warn('Polling failed', e);
    }
  }, 15000);
}
// startPolling(); // aktivlashtirish uchun uncomment qiling
</script>
</body>
</html>
