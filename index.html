<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Game Market ‚Äî Mini App</title>

  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa6b2; --accent:#3b82f6; --accent2:#10b981;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071226 0%, #081228 100%);color:#e6eef8;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .app {min-height:100vh; display:flex; flex-direction:column; padding-bottom:92px;}
    .container {max-width:1080px;margin:0 auto;padding:12px;}
    .logo{font-weight:700;font-size:18px;color:var(--accent);}
    .carousel {display:flex; gap:12px; overflow-x:auto; padding:8px 0; margin-bottom:12px; -webkit-overflow-scrolling:touch;}
    .carousel img{height:140px;border-radius:12px; object-fit:cover; flex-shrink:0; min-width:260px;}
    .cards {display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px;}
    .card {background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px; border-radius:12px; box-shadow:0 6px 18px rgba(2,6,23,0.6); position:relative; overflow:hidden;}
    .card img {width:100%; height:140px; object-fit:cover; border-radius:8px;}
    .card .title {font-weight:600; margin-top:8px; color:#e6eef8;}
    .card .meta {font-size:13px;color:var(--muted); margin-top:6px;}
    .card .actions {display:flex; gap:8px; margin-top:10px; align-items:center;}
    .btn {padding:8px 10px; border-radius:10px; cursor:pointer; border:none; font-weight:600;}
    .btn-primary {background:linear-gradient(90deg,var(--accent),#60a5fa); color:white;}
    .btn-ghost {background:transparent;color:var(--muted); border:1px solid rgba(255,255,255,0.04);}
    .menu-dot {position:absolute; top:10px; right:10px; font-size:18px; cursor:pointer; padding:6px; border-radius:8px; background:rgba(255,255,255,0.02);}
    .menu-box {position:absolute; right:12px; top:38px; background:#051022; border-radius:8px; padding:6px; display:none; z-index:40; border:1px solid rgba(255,255,255,0.03);}
    .menu-box button{display:block; width:200px; text-align:left; padding:8px; border:none; background:transparent; color:var(--muted); cursor:pointer;}

    .page {display:none;}
    .page.active {display:block;}
    .bottom-nav {position:fixed; left:0; right:0; bottom:0; height:72px; background:linear-gradient(180deg, rgba(2,6,23,0.94), rgba(2,6,23,0.98)); display:flex; gap:8px; justify-content:center; align-items:center; border-top:1px solid rgba(255,255,255,0.03); z-index:70;}
    .nav-item{flex:1; text-align:center; color:var(--muted); font-weight:700; cursor:pointer;}
    .nav-item.active{color:var(--accent);}

    /* Chat */
    .chat-wrap {display:flex; flex-direction:column; height:calc(100vh - 140px);}
    .messages{flex:1; overflow:auto; padding:12px; background:linear-gradient(180deg,transparent, rgba(0,0,0,0.06)); border-radius:8px;}
    .chat-input-wrap{display:flex; gap:8px; padding:10px; border-top:1px solid rgba(255,255,255,0.03); background:linear-gradient(180deg,#071226,#081226); align-items:center; position:relative;}
    .chat-input{flex:1; padding:10px 12px; border-radius:999px; background:#061022; border:1px solid rgba(255,255,255,0.03); color:#dfeefe;}
    .msg.user{background:#06202f; align-self:flex-end; margin:8px; padding:10px; border-radius:10px; max-width:78%;}
    .msg.admin{background:#0b2a39; align-self:flex-start; margin:8px; padding:10px; border-radius:10px; max-width:78%;}
    .msg img{max-width:220px; border-radius:8px; display:block; margin-top:8px;}
    .modal-overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:80}
    .modal{background:#041022;padding:16px;border-radius:12px;width:100%;max-width:720px;border:1px solid rgba(255,255,255,0.03)}
    @media (max-width:768px){ .cards{grid-template-columns:1fr} .carousel img{min-width:200px;height:120px} .menu-box button{width:160px} }
  </style>
</head>
<body>
  <div class="app">
    <div class="container">
      <header class="flex items-center justify-between mb-2">
        <div class="logo">Game Market</div>
        <div class="flex items-center gap-2">
          <button id="btnCreateListing" class="btn btn-ghost">E'lon yaratish</button>
          <button id="btnAdminToggle" class="btn btn-ghost">Admin</button>
        </div>
      </header>

      <!-- HOME -->
      <main id="home-page" class="page active">
        <div id="carousel" class="carousel" aria-hidden="false"></div>

        <section>
          <h3 class="text-lg font-semibold mb-2">Barcha mahsulotlar</h3>
          <div id="cards" class="cards"></div>
        </section>
      </main>

      <!-- MY LISTINGS -->
      <section id="my-listings-page" class="page p-4">
        <h3 class="text-lg font-semibold mb-3">Mening e'lonlarim</h3>
        <div id="my-listings" class="cards"></div>
      </section>

      <!-- PROFILE -->
      <section id="profile-page" class="page p-4">
        <div id="profile-area"></div>
      </section>

      <!-- CHAT / SUPPORT -->
      <section id="chat-page" class="page p-0">
        <div class="chat-wrap p-4">
          <div id="chat-header" class="flex items-center gap-3 mb-3">
            <img src="https://via.placeholder.com/40/2ea6ff/ffffff?text=AI" class="w-10 h-10 rounded-full">
            <div>
              <div class="font-bold">Qo'llab-quvvatlash</div>
              <div class="text-sm text-gray-400" id="chat-sub">AI yordamchi</div>
            </div>
          </div>

          <div class="messages" id="chat-messages">
            <div class="msg admin">Salom! Game Market ilovasiga xush kelibsiz!</div>
          </div>

          <div class="chat-input-wrap">
            <input id="chat-input" class="chat-input" placeholder="Xabar yozing..." />
            <input id="chat-file" type="file" accept="image/*" style="display:none" />
            <button id="btnAttach" class="btn btn-ghost">üñº</button>
            <button id="btnSend" class="btn btn-primary">Yuborish</button>
          </div>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="admin-page" class="page p-4">
        <h3 class="text-lg font-semibold mb-3">Admin Panel</h3>

        <div class="mb-4 p-3 bg-[#04142a] rounded">
          <h4 class="font-bold">‚öôÔ∏è Tizim sozlamalari</h4>
          <div class="mt-2 space-y-2">
            <label class="flex items-center gap-2">
              <input id="setting-admin-purchase" type="checkbox"/>
              <span>Admin orqali sotib olishni yoqish</span>
            </label>

            <div class="flex gap-2">
              <input id="setting-buyer-admin-cost" type="number" placeholder="Admin yordam narxi (yulduz)" class="p-2 rounded bg-[#06122a] flex-1" />
              <input id="setting-listing-cost" type="number" placeholder="E'lon narxi (yulduz)" class="p-2 rounded bg-[#06122a] flex-1" />
            </div>

            <div class="flex gap-2">
              <input id="setting-commission-rate" type="number" placeholder="Komissiya (foiz)" class="p-2 rounded bg-[#06122a] flex-1" />
              <button id="save-settings" class="btn btn-primary">Saqlash</button>
            </div>

            <div id="admin-warning" class="text-yellow-400 mt-2"></div>
          </div>
        </div>

        <div class="mb-4 p-3 bg-[#04142a] rounded">
          <h4 class="font-bold">üñº Carousel (faqat admin)</h4>
          <div class="mt-2">
            <input id="carousel-input" type="file" accept="image/*" />
            <button id="upload-carousel" class="btn btn-primary mt-2">Rasmni joylashtirish</button>
            <div id="carousel-msg" class="text-muted mt-2"></div>
          </div>
        </div>

      </section>

    </div>

    <!-- bottom nav -->
    <nav class="bottom-nav" id="bottom-nav">
      <div class="nav-item active" data-target="home-page">Bosh sahifa</div>
      <div class="nav-item" data-target="my-listings-page">Mening e'lonlarim</div>
      <div class="nav-item" data-target="profile-page">Profil</div>
      <div class="nav-item" data-target="chat-page">Yordam</div>
      <div class="nav-item" data-target="admin-page">Admin</div>
    </nav>
  </div>

  <!-- modal -->
  <div id="modal-root" style="display:none;" class="modal-overlay">
    <div class="modal" id="modal">
      <div id="modal-body"></div>
      <div class="mt-3 text-right"><button onclick="closeModal()" class="btn btn-ghost">Yopish</button></div>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const API_BASE = 'https://cyberuz81.alwaysdata.net/api'; // <-- o'zgartiring: sizning backend URL
const tg = window.Telegram ? window.Telegram.WebApp : null;

/* ================= STATE ================= */
let currentUser = {
  telegram_id: 0,
  username: 'guest',
  is_admin: false,
  is_blocked: false,
  balance: 0
};
let listings = [];
let carouselImages = [];
let adminAssignedBuyer = false; // quick flag, will be updated from backend

/* ================= HELPERS ================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function showPage(id){
  $$('.page').forEach(p=>p.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  $$('.nav-item').forEach(n=>n.classList.remove('active'));
  $$('.nav-item[data-target="'+id+'"]').forEach(n=>n.classList.add('active'));
  if (id==='chat-page') loadChatHistory();
}
function openModal(html){
  $('#modal-body').innerHTML = html;
  $('#modal-root').style.display='flex';
}
function closeModal(){ $('#modal-root').style.display='none'; $('#modal-body').innerHTML=''; }
function toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* ================= INIT UI ================= */
document.addEventListener('DOMContentLoaded', async ()=>{
  attachNav();
  attachButtons();
  await loadInitialData();
  renderAll();
});

/* ================= NAV ================= */
function attachNav(){
  $$('.nav-item').forEach(el=>{
    el.addEventListener('click', ()=> showPage(el.dataset.target));
  });
}

/* ================= BUTTONS ================= */
function attachButtons(){
  $('#btnCreateListing').addEventListener('click', ()=> openCreateListing());
  $('#btnAdminToggle').addEventListener('click', ()=> {
    // flip admin mode for demo; in real app use real user data
    currentUser.is_admin = !currentUser.is_admin;
    renderAll();
    alert('Admin mode: ' + (currentUser.is_admin ? 'ON' : 'OFF'));
  });

  // Chat
  $('#btnAttach').addEventListener('click', ()=> $('#chat-file').click());
  $('#chat-file').addEventListener('change', ()=> {
    const f = $('#chat-file').files[0];
    if (f) $('#chat-input').placeholder = 'Rasm tanlandi: ' + f.name + ' ‚Äî yuborish uchun Yuborish tugmasini bosing';
  });
  $('#btnSend').addEventListener('click', sendChatMessage);
  $('#chat-input').addEventListener('keydown', (e)=> { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChatMessage(); } });

  // settings save
  $('#save-settings').addEventListener('click', updateSystemSettings);

  // carousel upload
  $('#upload-carousel').addEventListener('click', uploadCarouselImage);
}

/* ================= LOAD / RENDER ================= */
async function loadInitialData(){
  try {
    // load items
    const itRes = await fetch(`${API_BASE}/items`).catch(()=>null);
    if (itRes && itRes.ok) { const d = await itRes.json(); listings = d.items || []; } else listings = [];

    // load advertisements
    const adRes = await fetch(`${API_BASE}/advertisements`).catch(()=>null);
    if (adRes && adRes.ok){ const ad = await adRes.json(); carouselImages = (ad.advertisements || []).map(a=>a.image).filter(Boolean); }
    else carouselImages = [];

    // load settings
    const sres = await fetch(`${API_BASE}/admin/settings`).catch(()=>null);
    if (sres && sres.ok){
      const sd = await sres.json();
      // simple mapping: if backend returns array of settings convert to object
      let settingsObj = {};
      if (Array.isArray(sd.settings)) sd.settings.forEach(s=> settingsObj[s.type] = s.data);
      const sys = settingsObj['system_settings'] || sd.system_settings || { admin_purchase_enabled:true, buyer_admin_cost:25, listing_cost:10, commission_rate:0.1 };
      $('#setting-admin-purchase').checked = !!sys.admin_purchase_enabled;
      $('#setting-buyer-admin-cost').value = sys.buyer_admin_cost || 25;
      $('#setting-listing-cost').value = sys.listing_cost || 10;
      $('#setting-commission-rate').value = Math.round((sys.commission_rate||0.1)*100);
    }

    // check buyer_admin exist
    const qres = await fetch(`${API_BASE}/admin/users/search`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ admin_telegram_id: currentUser.telegram_id, query: '' }) }).catch(()=>null);
    if (qres && qres.ok){
      const qd = await qres.json();
      adminAssignedBuyer = (qd.users || []).some(u=> u.role === 'buyer_admin');
      $('#admin-warning').textContent = adminAssignedBuyer ? '' : 'Avval buyer_admin rolini tayinlang (Admin orqali sotib olish uchun).';
    }
  } catch(e){
    console.warn('Load initial failed', e);
  }
}

function renderAll(){
  renderCarousel();
  renderCards();
  renderMyListings();
  renderProfile();
}

/* CAROUSEL: show only for admin */
function renderCarousel(){
  const wrap = $('#carousel'); wrap.innerHTML='';
  if (!currentUser.is_admin || !carouselImages.length){ wrap.style.display='none'; return; }
  wrap.style.display='flex';
  carouselImages.forEach(src=>{
    const img = document.createElement('img'); img.src = src; wrap.appendChild(img);
  });
}

/* CARDS */
function renderCards(){
  const c = $('#cards'); c.innerHTML = '';
  const items = listings.filter(x=> x && x.status !== 'sold');
  // admin items first
  const adminItems = items.filter(i => i.is_admin_item);
  let other = items.filter(i => !i.is_admin_item);
  // shuffle other for randomness
  for (let i = other.length-1; i>0; i--){ const j = Math.floor(Math.random()*(i+1)); [other[i], other[j]]=[other[j], other[i]]; }
  const all = [...adminItems, ...other];
  all.forEach(it=>{
    const card = document.createElement('div'); card.className='card';
    const img = (it.images && it.images[0]) ? it.images[0] : 'https://via.placeholder.com/640x360?text=Account';
    card.innerHTML = `
      <div class="menu-dot">‚ãÆ</div>
      <div class="menu-box" style="display:none">
        <button onclick="copyLink('${it._id||it.id}')">Havolani nusxalash</button>
        <button onclick="shareListing('${it._id||it.id}')">Ulashish</button>
      </div>
      <img src="${escape(it.images && it.images[0] ? it.images[0] : 'https://via.placeholder.com/640x360')}" alt="">
      <div class="title">${escape(it.title||it.item_title||'‚Äî')}</div>
      <div class="meta">Platforma: ${escape(it.platform||'‚Äî')} ‚Ä¢ Narx: ${escape(String(it.price||it.price_stars||0))} ‚≠ê</div>
      <div class="actions">
        ${ it.is_admin_item ? `<button class="btn btn-primary" onclick="buyPrompt('${it._id||it.id}')">${escape(String(it.price||it.price_stars||0))} ‚≠ê Sotib olish</button>` : ''}
        <button class="btn btn-ghost" onclick="openDetail('${it._id||it.id}')">Ko'rish</button>
      </div>
    `;
    c.appendChild(card);
    const dot = card.querySelector('.menu-dot'), box = card.querySelector('.menu-box');
    dot.addEventListener('click', e=>{ e.stopPropagation(); document.querySelectorAll('.menu-box').forEach(b=>b.style.display='none'); box.style.display = box.style.display==='block' ? 'none' : 'block'; });
  });
  document.body.addEventListener('click', ()=> document.querySelectorAll('.menu-box').forEach(b=>b.style.display='none'));
}

/* MY LISTINGS (user) */
function renderMyListings(){
  const cont = $('#my-listings'); cont.innerHTML='';
  const me = listings.filter(l => (l.seller_telegram_id && l.seller_telegram_id === currentUser.telegram_id) || (l.owner && l.owner === currentUser.username));
  if (!me.length){ cont.innerHTML = '<div class="text-muted text-gray-400">Hozircha e\'lonlaringiz yo\'q</div>'; return; }
  me.forEach(l=>{
    const el = document.createElement('div'); el.className='card';
    const img = (l.images && l.images[0]) || 'https://via.placeholder.com/640x360?text=Account';
    el.innerHTML = `<img src="${escape(img)}"/><div class="title">${escape(l.title||l.item_title)}</div><div class="meta">Narx: ${escape(String(l.price||l.price_stars||0))} ‚≠ê</div>
      <div class="actions">
        <button class="btn btn-ghost" onclick="openEdit('${l._id||l.id}')">Edit</button>
        <button class="btn btn-ghost" onclick="confirmDelete('${l._id||l.id}')">Delete</button>
        <button class="btn btn-primary" onclick="markSold('${l._id||l.id}')">${l.status==='sold' ? 'Sotildi' : 'Mark Sotildi'}</button>
      </div>`;
    cont.appendChild(el);
  });
}

/* PROFILE */
function renderProfile(){
  const area = $('#profile-area'); area.innerHTML='';
  if (currentUser.is_blocked){
    area.innerHTML = `<div class="p-4 bg-[#061022] rounded"><div class="font-bold">Siz bloklangansiz</div></div>`;
    return;
  }
  area.innerHTML = `<div class="card" style="display:flex;gap:12px;align-items:center"><img src="https://via.placeholder.com/96" style="width:96px;height:96px;border-radius:12px;object-fit:cover"/><div><div style="font-weight:700">Foydalanuvchi: ${escape(currentUser.username)}</div><div style="color:var(--muted)">Balance: <span id="balance-val">${escape(String(currentUser.balance||0))}</span> ‚≠ê</div></div></div>`;
}

/* ================= UTIL ================= */
function escape(s){ return s===null||s===undefined ? '' : String(s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;",'`':'&#96;'}[c])); }

/* ================= DETAILS / BUY ================= */
function openDetail(id){
  const it = listings.find(x=> (x._id||x.id) == id) || {};
  openModal(`<h3 class="font-bold mb-2">${escape(it.title||it.item_title||'‚Äî')}</h3>
    <p>Platform: ${escape(it.platform||'‚Äî')}</p>
    <p>Narx: ${escape(String(it.price||it.price_stars||0))} ‚≠ê</p>
    <div class="mt-4"><button class="btn btn-primary" onclick="buyPrompt('${id}')">Sotib olish</button></div>`);
}
function buyPrompt(id){
  closeModal();
  const it = listings.find(l=> (l._id||l.id)==id);
  if (!it) return alert('Topilmadi');
  if (!confirm(`${escape(it.title||'')}\nNarx: ${escape(String(it.price||it.price_stars||0))} ‚≠ê\nTo'lovni boshlaysizmi?`)) return;
  buyItem(id);
}

async function buyItem(id){
  try {
    const it = listings.find(l=> (l._id||l.id) == id);
    if (!it) return alert('Topilmadi');
    // call backend to create invoice_link
    const res = await fetch(`${API_BASE}/payment/create-invoice`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ telegram_id: currentUser.telegram_id, stars: it.price || it.price_stars || 0, item_id: id })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Invoice yaratilmadi');
    if (data.test_mode){
      // test: add balance or simulate
      alert('Test rejimida to\'lov bajarildi');
      return;
    }
    if (data.invoice_link){
      // Open invoice inside Telegram WebApp if supported, otherwise new tab
      try {
        if (tg && typeof tg.openInvoice === 'function'){
          // some Telegram WebApp versions provide openInvoice
          tg.openInvoice(data.invoice_link);
        } else {
          window.open(data.invoice_link, '_blank');
        }
      } catch(e){
        window.open(data.invoice_link, '_blank');
      }
      alert('To\'lov oynasi ochildi. Telegramni tekshiring.');
    } else if (data.payload){
      alert('Invoice bot tomonidan yuborildi. Telegramda tekshiring.');
    } else {
      alert('Serverdan noma ºlum javob keldi.');
    }
  } catch(e){ console.error(e); alert('Xato: ' + (e.message || e)); }
}

/* ================= STARS BUY (quick) ================= */
async function buyStars(amount){
  try {
    const res = await fetch(`${API_BASE}/payment/create-invoice`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ telegram_id: currentUser.telegram_id, stars: amount })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Invoice yaratilmadi');
    if (data.test_mode){
      currentUser.balance = (currentUser.balance||0) + amount;
      $('#balance-val').textContent = currentUser.balance;
      alert(amount + ' ‚≠ê test rejimida qo\'shildi');
      return;
    }
    if (data.invoice_link){
      try { if (tg && typeof tg.openInvoice === 'function') tg.openInvoice(data.invoice_link); else window.open(data.invoice_link,'_blank'); }
      catch(e){ window.open(data.invoice_link,'_blank'); }
      alert('To\'lov oynasi ochildi');
    } else alert('Invoice yo\'q');
  } catch(e){ alert('Xato: ' + (e.message || e)); }
}

/* ================= CHAT ================= */
/* load chat history */
async function loadChatHistory(){
  try {
    const resp = await fetch(`${API_BASE}/chat/history/${currentUser.telegram_id}`).catch(()=>null);
    const box = $('#chat-messages'); box.innerHTML = '';
    if (!resp || !resp.ok){ box.innerHTML = '<div class="msg admin">Chat tarixini yuklab bo\'lmadi</div>'; return; }
    const d = await resp.json();
    const msgs = d.messages || [];
    msgs.forEach(m=>{
      const div = document.createElement('div'); div.className = m.sender_type==='user' ? 'msg user' : 'msg admin';
      div.innerHTML = escape(m.message || '');
      if (m.image) { const im = document.createElement('img'); im.src = m.image; div.appendChild(im); }
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  } catch(e){ console.error(e); }
}

/* send chat message with optional image */
async function sendChatMessage(){
  const text = $('#chat-input').value.trim();
  const file = $('#chat-file').files[0];
  if (!text && !file) return alert('Xabar yoki rasm tanlang');
  let image_base64 = null;
  if (file){
    image_base64 = await toBase64(file);
  }
  try {
    const payload = { user_telegram_id: currentUser.telegram_id, message: text || '', image_base64 };
    const res = await fetch(`${API_BASE}/chat/send`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Chat send failed');
    // append message locally
    const box = $('#chat-messages');
    const userDiv = document.createElement('div'); userDiv.className='msg user'; userDiv.textContent = text || (file ? 'Rasm yuborildi' : '');
    if (image_base64){ const img = document.createElement('img'); img.src = image_base64; userDiv.appendChild(img); }
    box.appendChild(userDiv);
    // if server returns admin/ai reply include it
    if (data.admin_response || data.ai_response){
      const ad = document.createElement('div'); ad.className='msg admin'; ad.textContent = data.admin_response || data.ai_response;
      box.appendChild(ad);
    }
    box.scrollTop = box.scrollHeight;
    $('#chat-input').value=''; $('#chat-file').value=''; $('#chat-input').placeholder='Xabar yozing...';
  } catch(e){ console.error(e); alert('Xato: ' + (e.message || e)); }
}

/* ================= ADMIN: upload carousel image ================= */
async function uploadCarouselImage(){
  if (!currentUser.is_admin) return alert('Faqat adminlar ruxsat etilgan');
  const file = $('#carousel-input').files[0];
  if (!file) return alert('Rasm tanlang');
  const b64 = await toBase64(file);
  try {
    const payload = { user_telegram_id: currentUser.telegram_id, ad_package:'basic', image: b64 };
    const res = await fetch(`${API_BASE}/advertisements`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Upload failed');
    $('#carousel-msg').textContent = 'Rasm yuklandi';
    // refresh
    await loadInitialData();
    renderAll();
  } catch(e){ alert('Xato: ' + (e.message || e)); }
}

/* ================= ADMIN SETTINGS SAVE ================= */
async function updateSystemSettings(){
  if (!currentUser.is_admin) return alert('Faqat adminlar ruxsat etilgan');
  const body = {
    admin_telegram_id: currentUser.telegram_id,
    type: 'system_settings',
    data: {
      admin_purchase_enabled: !!$('#setting-admin-purchase').checked,
      buyer_admin_cost: parseFloat($('#setting-buyer-admin-cost').value) || 25,
      listing_cost: parseFloat($('#setting-listing-cost').value) || 10,
      commission_rate: (parseFloat($('#setting-commission-rate').value) || 10)/100
    }
  };
  try {
    const res = await fetch(`${API_BASE}/admin/settings`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const d = await res.json();
    if (!res.ok) throw new Error(d.error || 'Settings save failed');
    alert('Sozlamalar saqlandi');
  } catch(e){ alert('Xato: ' + (e.message || e)); }
}

/* ================= CRUD helpers (minimal) ================= */
function openCreateListing(){
  openModal(`<h3 class="font-bold">E'lon yaratish</h3>
    <div class="mt-2"><label class="block text-sm">Nomi</label><input id="new-title" class="w-full p-2 rounded bg-[#061022]"/></div>
    <div class="mt-2"><label class="block text-sm">Narx (yulduz)</label><input id="new-price" class="w-full p-2 rounded bg-[#061022]"/></div>
    <div class="mt-3 text-right"><button class="btn btn-primary" onclick="createListing()">Yaratish</button></div>`);
}
async function createListing(){
  const title = $('#new-title').value.trim(); const price = parseFloat($('#new-price').value) || 0;
  if (!title) return alert('Nomi kiriting');
  try {
    const res = await fetch(`${API_BASE}/items`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title, price, seller_telegram_id: currentUser.telegram_id })});
    if (!res.ok) throw new Error('Create failed');
    const d = await res.json();
    listings.unshift(d.item || {});
    renderAll(); closeModal();
    alert('E\'lon yaratildi');
  } catch(e){ alert('Xato: ' + (e.message||e)); }
}

function openEdit(id){ openModal(`<div>Editing ${id} ‚Äî backend required</div>`); }
function confirmDelete(id){ if (confirm('O\'chirmoqchimisiz?')) deleteItem(id); }
async function deleteItem(id){
  try {
    const res = await fetch(`${API_BASE}/items/${id}`, { method:'DELETE' });
    if (!res.ok) throw new Error('Delete failed');
    listings = listings.filter(x=> (x._id||x.id) !== id); renderAll(); alert('O\'chirildi');
  } catch(e){ alert('Xato: ' + (e.message||e)); }
}
async function markSold(id){
  try {
    await fetch(`${API_BASE}/items/${id}/mark-sold`, { method:'POST' }).catch(()=>{});
    const it = listings.find(x=> (x._id||x.id) === id); if (it) it.status='sold'; renderAll();
    alert('Belgilandi');
  } catch(e){ alert('Xato'); }
}

/* ================= COPY/SHARE ================= */
function copyLink(id){ const url = location.origin + location.pathname + '?listing=' + id; navigator.clipboard.writeText(url).then(()=>alert('Havola nusxalandi')); }
function shareListing(id){ const url = location.origin + location.pathname + '?listing=' + id; if (navigator.share) navigator.share({title:'E\'lon', text:'Bu e\'lonni ko\'ring', url}).catch(()=>{}); else alert('Link: ' + url); }

</script>
</body>
</html>
